variables:
  GIT_SSL_NO_VERIFY: "1"

  # Commit of ghc/ci-images repository from which to pull Docker images
  DOCKER_REV: cefaee3c742af193e0f7783f87edb0d35374515c

############################################################
# CI Step
############################################################

.debian:
  image: "registry.gitlab.haskell.org/ghc/ci-images/x86_64-linux-deb9:$DOCKER_REV"
  tags:
    - x86_64-linux

.darwin:
  tags:
    - x86_64-darwin

.freebsd:
  tags:
    - x86_64-freebsd

.test_ghcup_version:
  script:
    - ./.gitlab/script/ghcup_version.sh
  variables:
    JSON_VERSION: "0.0.1"

.test_ghcup_version:linux:
  extends:
    - .test_ghcup_version
    - .debian
  before_script:
    - ./.gitlab/before_script/linux/install_deps.sh
  variables:
    OS: "LINUX"

.test_ghcup_version:darwin:
  extends:
    - .test_ghcup_version
    - .darwin
  before_script:
    - ./.gitlab/before_script/darwin/install_deps.sh
  variables:
    OS: "DARWIN"
  after_script:
    - BUILD_DIR=$CI_PROJECT_DIR
    - echo "Cleaning $BUILD_DIR"
    - cd $HOME
    - rm -Rf "$BUILD_DIR"/*
    - exit 0


.test_ghcup_version:freebsd:
  extends:
    - .test_ghcup_version
    - .freebsd
  before_script:
    - ./.gitlab/before_script/freebsd/install_deps.sh
  variables:
    OS: "FREEBSD"
  after_script:
    - BUILD_DIR=$CI_PROJECT_DIR
    - echo "Cleaning $BUILD_DIR"
    - cd $HOME
    - rm -Rf "$BUILD_DIR"/*
    - exit 0



######## linux test ########

test:linux:recommended:
  extends: .test_ghcup_version:linux
  variables:
    GHC_VERSION: "8.6.5"
    CABAL_VERSION: "3.2.0.0"

test:linux:latest:
  extends: .test_ghcup_version:linux
  variables:
    GHC_VERSION: "8.8.3"
    CABAL_VERSION: "3.2.0.0"
  allow_failure: true


######## darwin test ########

test:mac:recommended:
  extends: .test_ghcup_version:darwin
  variables:
    GHC_VERSION: "8.6.5"
    CABAL_VERSION: "3.2.0.0"

test:mac:latest:
  extends: .test_ghcup_version:darwin
  variables:
    GHC_VERSION: "8.8.3"
    CABAL_VERSION: "3.2.0.0"
  allow_failure: true


######## freebsd test ########

test:freebsd:recommended:
  extends: .test_ghcup_version:freebsd
  variables:
    GHC_VERSION: "8.6.5"
    CABAL_VERSION: "3.2.0.0"

test:freebsd:latest:
  extends: .test_ghcup_version:freebsd
  variables:
    GHC_VERSION: "8.8.3"
    CABAL_VERSION: "3.2.0.0"
  allow_failure: true

